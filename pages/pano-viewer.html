<style>
    /* hide the standard squarespace header and footer */
    #header, #footer-sections, .sqs-announcement-bar {
        display: none !important;
    }

    /* force the page body and panorama to fill the screen */
    html, body {
        margin: 0 !important;
        padding: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        overflow: hidden !important;
    }
    
    #panorama {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100%;
        height: 100%;
        z-index: 9999 !important; /* bring the panorama to the very front */
    }
</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
<script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

<div id="panorama"></div>

<script>
    document.addEventListener("DOMContentLoaded", async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const panoFile = urlParams.get('pano');

        if (!panoFile) {
            document.getElementById('panorama').innerText = 'Error: No panorama file specified.';
            return;
        }

        const correctionDataUrl = "https://east-southeast-llc.github.io/ese-map-viewer/data/correction-data.json";
        
        try {
            const response = await fetch(correctionDataUrl);
            if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
            const panoData = await response.json();
            const pose = panoData[panoFile];

            const viewerConfig = {
                "type": "equirectangular",
                "panorama": `https://www.ese-llc.com/s/${panoFile}`,
                "autoLoad": true,
                "showControls": false
            };

            if (pose && pose.orientation) {
                const q = pose.orientation;
                const sinr_cosp = 2 * (q.w * q.x + q.y * q.z);
                const cosr_cosp = 1 - 2 * (q.x * q.x + q.y * q.y);
                viewerConfig.horizonRoll = Math.atan2(sinr_cosp, cosr_cosp) * (180 / Math.PI);
                
                const sinp = 2 * (q.w * q.y - q.z * q.x);
                let pitch = Math.abs(sinp) >= 1 ? (Math.sign(sinp) * Math.PI / 2) * (180 / Math.PI) : Math.asin(sinp) * (180 / Math.PI);
                viewerConfig.horizonPitch = -pitch;
            }
            
            pannellum.viewer('panorama', viewerConfig);

        } catch (error) {
            console.error("Error loading panorama:", error);
            document.getElementById('panorama').innerText = `A critical error occurred: ${error.message}`;
        }
    });
</script>